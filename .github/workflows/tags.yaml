name: Test and merge to dev
on:
  push:
    branches:
      - "!dev"
    tags:
      - "feat*"
      - "fix*"
      - "perf*"
      - "build*"
      - "ci*"
      - "chore*"
      - "docs*"
      - "style*"
      - "refactor*"
      - "test*"
jobs:
  run-tests:
    uses: .github/workflows/run-tests.yaml
    with:
      tag: ${{ github.ref_name }}

  update-git-dev:
    runs-on: ubuntu-latest
    needs: run-tests
    if : not StartsWith(github.ref_name, 'test')
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      - name: Git operations to merge and push to dev
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git fetch
          git rebase origin/dev
          git checkout dev
          git pull origin dev
          git merge --no-ff ${{ github.head_ref }}
          git commit -a -m "github-actions[bot] - ${{ github.ref_name }} - ${{ github.sha }}"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: dev
