name: Test and merge to dev
on:
  push:
    branches:
      - "feat/*"
      - "fix/*"
      - "perf/*"
      - "build/*"
      - "style/*"
      - "refactor/*"
      - "test/*"

permissions:
  id-token: write # This is required for requesting the JWT
  contents: write  # This is required for actions/checkout
jobs:
  run-tests:
    uses: ./.github/workflows/run-tests.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read

  create-pr:
    runs-on: ubuntu-latest
    needs: run-tests
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main

      - name: git pull
        run: |
          git pull origin ${{ github.ref_name }}

      - name: Create PR to Master
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GH_PAT }}
          base: 'main' # the target branch for PR
          branch: ci/${{ github.ref_name }}-to-main  # source branch
          title: '🤖📦🐍 ${{ github.ref_name }} → main'
          body: 'AUTO-PR. Please review the changes before merging.'
          labels: 'automated,autosquash'
          commit-message: AUTO - ${{ github.ref_name }}
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>

